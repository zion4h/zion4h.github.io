<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>Prometheus 全链路监控实战： Nginx QPS、ComfyUI 存活、GPU 指标，到 Docker-VPN 网段踩坑记录 - Blowin&#039; in the Wind</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="Welcome to H&#039;s Blog"><meta name="msapplication-TileImage" content="/img/kitty.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Welcome to H&#039;s Blog"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="一篇给团队新人看的「一把梭」笔记： • 打开 Nginx 详细指标（QPS &amp;#x2F; P99 &amp;#x2F; 5xx） • 用 Blackbox 监控 ComfyUI 是否挂掉 • GPU 机器指标怎么进 Prometheus • Docker-Compose + VPN 网段冲突到底怎么解决 • 最后把冗长的 Prometheus YAML 缩成 1&amp;#x2F;2 能抄就抄，能跑就行。"><meta property="og:type" content="blog"><meta property="og:title" content="Prometheus 全链路监控实战： Nginx QPS、ComfyUI 存活、GPU 指标，到 Docker-VPN 网段踩坑记录"><meta property="og:url" content="https://zion4h.github.io/2025/06/09/2025-6-9-Prometheus%E8%BF%9B%E9%98%B6-Nginx%E8%B4%9F%E8%BD%BD%E3%80%81Comfy%E5%AD%98%E6%B4%BB%E3%80%81GPU%E8%8A%82%E7%82%B9%E4%B8%8EYAML%E7%B2%BE%E7%AE%80/"><meta property="og:site_name" content="Blowin&#039; in the Wind"><meta property="og:description" content="一篇给团队新人看的「一把梭」笔记： • 打开 Nginx 详细指标（QPS &amp;#x2F; P99 &amp;#x2F; 5xx） • 用 Blackbox 监控 ComfyUI 是否挂掉 • GPU 机器指标怎么进 Prometheus • Docker-Compose + VPN 网段冲突到底怎么解决 • 最后把冗长的 Prometheus YAML 缩成 1&amp;#x2F;2 能抄就抄，能跑就行。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://zion4h.github.io/img/og_image.png"><meta property="article:published_time" content="2025-06-09T06:00:00.000Z"><meta property="article:modified_time" content="2025-06-16T06:13:19.570Z"><meta property="article:author" content="zion h4"><meta property="article:tag" content="Prometheus"><meta property="article:tag" content="Nginx"><meta property="article:tag" content="GPU"><meta property="article:tag" content="Blackbox"><meta property="article:tag" content="Docker"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://zion4h.github.io/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://zion4h.github.io/2025/06/09/2025-6-9-Prometheus%E8%BF%9B%E9%98%B6-Nginx%E8%B4%9F%E8%BD%BD%E3%80%81Comfy%E5%AD%98%E6%B4%BB%E3%80%81GPU%E8%8A%82%E7%82%B9%E4%B8%8EYAML%E7%B2%BE%E7%AE%80/"},"headline":"Prometheus 全链路监控实战： Nginx QPS、ComfyUI 存活、GPU 指标，到 Docker-VPN 网段踩坑记录","image":["https://zion4h.github.io/img/og_image.png"],"datePublished":"2025-06-09T06:00:00.000Z","dateModified":"2025-06-16T06:13:19.570Z","author":{"@type":"Person","name":"zion h4"},"publisher":{"@type":"Organization","name":"Blowin' in the Wind","logo":{"@type":"ImageObject","url":"https://zion4h.github.io/img/kitty.png"}},"description":"一篇给团队新人看的「一把梭」笔记： • 打开 Nginx 详细指标（QPS &#x2F; P99 &#x2F; 5xx） • 用 Blackbox 监控 ComfyUI 是否挂掉 • GPU 机器指标怎么进 Prometheus • Docker-Compose + VPN 网段冲突到底怎么解决 • 最后把冗长的 Prometheus YAML 缩成 1&#x2F;2 能抄就抄，能跑就行。"}</script><link rel="canonical" href="https://zion4h.github.io/2025/06/09/2025-6-9-Prometheus%E8%BF%9B%E9%98%B6-Nginx%E8%B4%9F%E8%BD%BD%E3%80%81Comfy%E5%AD%98%E6%B4%BB%E3%80%81GPU%E8%8A%82%E7%82%B9%E4%B8%8EYAML%E7%B2%BE%E7%AE%80/"><link rel="alternate" href="https://zion4h.github.io/atom.xml" title="Blowin&#039; in the Wind" type="application/atom+xml"><link rel="icon" href="/img/kitty.png"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/mono-blue.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><script>var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "//hm.baidu.com/hm.js?a9f2a7370cea3cc47e78ce7e91a24ccc";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();</script><meta name="msvalidate.01" content="E57A0E10BC15ABA0F469F0806A5EDEB0"><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" defer></script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=G-PB49LZ7RGB" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'G-PB49LZ7RGB');</script><!--!--><!--!--><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="/img/kitty.png" alt="Blowin&#039; in the Wind" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zion4h"><i class="fab fa-github"></i></a><a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;"><i class="fas fa-list-ul"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2025-06-09T06:00:00.000Z" title="6/9/2025, 2:00:00 PM">2025-06-09</time>发表</span><span class="level-item"><time dateTime="2025-06-16T06:13:19.570Z" title="6/16/2025, 2:13:19 PM">2025-06-16</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Ops/">Ops</a></span><span class="level-item">22 分钟读完 (大约3293个字)</span><span class="level-item" id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv">0</span>次访问</span></div></div><h1 class="title is-3 is-size-4-mobile">Prometheus 全链路监控实战： Nginx QPS、ComfyUI 存活、GPU 指标，到 Docker-VPN 网段踩坑记录</h1><div class="content"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote>
<p>一篇给团队新人看的「一把梭」笔记：<br>
• 打开 Nginx 详细指标（QPS / P99 / 5xx）<br>
• 用 Blackbox 监控 ComfyUI 是否挂掉<br>
• GPU 机器指标怎么进 Prometheus<br>
• Docker-Compose + VPN 网段冲突到底怎么解决<br>
• 最后把冗长的 Prometheus YAML 缩成 1/2</p>
<p><strong>能抄就抄，能跑就行</strong>。</p>
</blockquote>
<span id="more"></span>
<hr>
<h1>0. 环境 &amp; 踩坑摘要</h1>
<table>
<thead>
<tr>
<th>角色</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>宿主机</td>
<td>Ubuntu 24.04 + Docker 28.2.2</td>
</tr>
<tr>
<td>VPN</td>
<td>公司 XVPN，出口段 <code>172.21.0.0/16</code></td>
</tr>
<tr>
<td>Compose</td>
<td>5 套（4 业务 + 1 监控），每套原本都会随机生成 <code>br-*</code> 网络（<code>172.18-31.*</code>）</td>
</tr>
<tr>
<td>坑点</td>
<td>某条 Docker Bridge 撞进 <code>172.21.*</code>，VPN / 容器互 ping 全挂</td>
</tr>
</tbody>
</table>
<p><strong>解决思路</strong></p>
<ol>
<li>手动建统一网 <code>dnet1</code>，让所有 Compose <code>default ➜ dnet1</code></li>
<li>或者从根上改 <code>/etc/docker/daemon.json</code>，限定 Docker 只能用 <code>192.168.240.0/20</code></li>
<li>Prometheus 里统统写 <strong>容器名：端口</strong>，别再 <code>127.0.0.1</code> 自己打自己</li>
<li>能不写 <code>container_name</code> 就不写，跨项目重名会炸</li>
</ol>
<p>下面按模块展开。</p>
<hr>
<h1>1．Nginx 负载监控</h1>
<p>本节目标：在 <strong>Docker-Compose</strong> 环境中构建一套「带 VTS 模块」的 Nginx 镜像，并通过 <code>nginx-vts-exporter</code> 把 QPS、延迟分位数、状态码分布等指标推送到 Prometheus。下面给出 <strong>完整、可直接粘贴的</strong> <code>compose</code>、<code>Dockerfile</code> 与 <code>nginx.conf</code>，同时解释每一行到底干了什么。</p>
<hr>
<h2 id="1-1-直接使用自编译-VTS-模块的-Nginx">1.1 直接使用自编译 VTS 模块的 Nginx</h2>
<h3 id="1-1-1-docker-compose-yml-片段">1.1.1 docker-compose.yml 片段</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="comment"># ──────────────────────────────────────────────</span></span><br><span class="line">  <span class="comment"># 带 VTS 模块的 Nginx</span></span><br><span class="line">  <span class="comment"># ──────────────────────────────────────────────</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./nginx-vts</span>        <span class="comment"># 存放 Dockerfile、nginx.conf、证书等</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-vts</span>     <span class="comment"># 仅此项目内唯一即可</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/base.crt:/etc/nginx/ssl/base.crt:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/base.key:/etc/nginx/ssl/base.key:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/nginx.conf:/etc/nginx/nginx.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/proxy_common.conf:/etc/nginx/conf.d/proxy_common.conf:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/.htpasswd:/etc/nginx/.htpasswd:ro</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># ──────────────────────────────────────────────</span></span><br><span class="line">  <span class="comment"># VTS 指标导出器</span></span><br><span class="line">  <span class="comment"># ──────────────────────────────────────────────</span></span><br><span class="line">  <span class="attr">nginx-vts-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sophos/nginx-vts-exporter:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-vts-exporter</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># 1) Basic-Auth：admin/password</span></span><br><span class="line">      <span class="comment"># 2) 访问路径：/status/format/json   ← nginx.conf 中固定</span></span><br><span class="line">      <span class="comment"># 3) HTTPS：因为上面 Nginx 监听 443</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NGINX_STATUS=https://admin:password@nginx:443/status/format/json</span></span><br><span class="line">      <span class="comment"># VTS 导出器自带的 TLS 校验证书开关</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TLS_SKIP_VERIFY=true</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9913:9913&quot;</span>                <span class="comment"># Prometheus 即抓取这个端口</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>要点</p>
<ol>
<li><code>nginx</code> 服务使用 <strong>自定义镜像</strong>（见下文 Dockerfile），镜像中已经把 VTS 编译进来。</li>
<li>证书、<code>nginx.conf</code>、通用反向代理配置和 <code>.htpasswd</code> 均以只读方式挂载。</li>
<li><code>nginx-vts-exporter</code> 通过环境变量 <code>NGINX_STATUS</code> 指向 <strong>Nginx 容器内部 DNS 名 nginx</strong>，省去写 IP。</li>
<li>监听 9913 端口，Prometheus 里就写 <code>nginx-vts-exporter:9913</code>。</li>
</ol>
<hr>
<h3 id="1-1-2-Dockerfile（双阶段编译）">1.1.2 Dockerfile（双阶段编译）</h3>
<blockquote>
<p>文件放在 <code>./nginx-vts/Dockerfile</code></p>
</blockquote>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#####################################################################</span></span><br><span class="line"><span class="comment"># 第一阶段：在官方 nginx 镜像里把 vts 模块编译进 deb 包</span></span><br><span class="line"><span class="comment">#####################################################################</span></span><br><span class="line"><span class="keyword">FROM</span> nginx:latest as buildenv</span><br><span class="line"></span><br><span class="line"><span class="keyword">ARG</span> NGINX_VTS_VERSION=<span class="string">&quot;0.2.3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 安装必要工具</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y --no-install-recommends \</span></span><br><span class="line"><span class="language-bash">        gnupg2 lsb-release dpkg-dev curl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 拉取官方源公钥并写入 keyring</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -fsSL https://nginx.org/keys/nginx_signing.key \</span></span><br><span class="line"><span class="language-bash">    | gpg --dearmor -o /usr/share/keyrings/nginx-archive-keyring.gpg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 添加 deb-src 仓库（为了拿到 nginx 源码包）</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;deb-src [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] \</span></span></span><br><span class="line"><span class="string"><span class="language-bash">     http://nginx.org/packages/debian <span class="subst">$(lsb_release -cs)</span> nginx&quot;</span> \</span></span><br><span class="line"><span class="language-bash">     &gt; /etc/apt/sources.list.d/nginx.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 更新索引并拉源码</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get <span class="built_in">source</span> nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 解析当前 nginx 版本号，装好 build-dep</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">export</span> NGINX_VERSION=$(dpkg-parsechangelog --show-field Version \</span></span><br><span class="line"><span class="language-bash">        &lt; ./nginx*/debian/changelog | <span class="built_in">head</span> -n1 | <span class="built_in">cut</span> -d<span class="string">&#x27;-&#x27;</span> -f1) &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get build-dep -y nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 下载 vts 模块源码</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> curl -sL https://github.com/vozlt/nginx-module-vts/archive/\</span></span><br><span class="line"><span class="language-bash">v<span class="variable">$&#123;NGINX_VTS_VERSION&#125;</span>.tar.gz \</span></span><br><span class="line"><span class="language-bash">    | tar -xz -C /</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 在 debian/rules 里插入“–add-module”</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> sed -i -r -e \</span></span><br><span class="line"><span class="language-bash">    <span class="string">&quot;s|\.\/configure(.*)|\.\/configure\1 --add-module=\/nginx-module-vts-<span class="variable">$&#123;NGINX_VTS_VERSION&#125;</span>|&quot;</span> \</span></span><br><span class="line"><span class="language-bash">    /nginx*/debian/rules</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 编译成 .deb</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">cd</span> /nginx* &amp;&amp; dpkg-buildpackage -b</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#####################################################################</span></span><br><span class="line"><span class="comment"># 第二阶段：最小化运行时镜像</span></span><br><span class="line"><span class="comment">#####################################################################</span></span><br><span class="line"><span class="keyword">FROM</span> nginx:latest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝刚才生成的 deb 安装包</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=buildenv /nginx_*.deb /tmp/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y /tmp/nginx_*.deb &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/* /tmp/nginx_*.deb</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 默认命令，前台启动</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;nginx&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;daemon off;&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>为什么用“两阶段”<br>
• 第一阶段装编译依赖，镜像体积 &gt;1 GB；<br>
• 第二阶段只复制结果 <code>.deb</code>，最终镜像 ≈150 MB，与官方体积相当。</p>
<hr>
<h3 id="1-1-3-nginx-conf（精简只展示-VTS-相关）">1.1.3 nginx.conf（精简只展示 VTS 相关）</h3>
<blockquote>
<p>文件放在 <code>./nginx-vts/nginx.conf</code></p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">load_module</span> modules/ngx_http_vhost_traffic_status_module.so;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 解析容器名字，禁用 IPv6 解析</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────</span></span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">127.0.0.11</span> ipv6=<span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 声明一块共享内存保存 VTS 指标</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────</span></span><br><span class="line">    vhost_traffic_status_zone;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────</span></span><br><span class="line">    <span class="comment"># 业务与状态页</span></span><br><span class="line">    <span class="comment"># ─────────────────────────────────────────</span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>              <span class="number">443</span> ssl;</span><br><span class="line">        <span class="attribute">server_name</span>         _;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">ssl_certificate</span>     /etc/nginx/ssl/base.crt;</span><br><span class="line">        <span class="attribute">ssl_certificate_key</span> /etc/nginx/ssl/base.key;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 业务 upstream /location 略……</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># -------- VTS Status Page -------------</span></span><br><span class="line">        <span class="section">location</span> /status &#123;</span><br><span class="line">            <span class="attribute">auth_basic</span>           <span class="string">&quot;vts&quot;</span>;</span><br><span class="line">            <span class="attribute">auth_basic_user_file</span> /etc/nginx/.htpasswd;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 在浏览器里直接看图表</span></span><br><span class="line">            vhost_traffic_status_display;</span><br><span class="line">            <span class="attribute">vhost_traffic_status_display_format</span> html;</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 如果 exporter 走 JSON，需要：</span></span><br><span class="line">            <span class="comment"># vhost_traffic_status_display_format prometheus;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Tips</p>
<ol>
<li><code>vhost_traffic_status_display_format html</code> → 手动访问 <code>/status</code> 有图形化界面；<br>
导出器会强制加 <code>format=json</code>，因此无需在这里专门改 <code>prometheus</code>。</li>
<li><code>auth_basic</code> 保护状态页，用户名/密码与 compose 中 <code>NGINX_STATUS=https://admin:password@...</code> 对应。</li>
<li><code>resolver 127.0.0.11</code> 让 Nginx 在容器内部解析其它服务名。</li>
</ol>
<hr>
<h3 id="1-1-4-Prometheus-抓取示例（仅供参考）">1.1.4 Prometheus 抓取示例（仅供参考）</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">nginx-vts</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;nginx-vts-exporter:9913&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>常见指标</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nginx_vts_server_requests_total&#123;code=&quot;2xx&quot;,host=&quot;api&quot;&#125;      # 每秒 QPS</span><br><span class="line">nginx_vts_server_response_time_seconds_p99&#123;host=&quot;api&quot;&#125;      # P99 延迟</span><br><span class="line">nginx_vts_filter_bytes_in_total&#123;filter=&quot;upstream&quot;,upstream=&quot;backend&quot;&#125;  # 流量</span><br></pre></td></tr></table></figure>
<hr>
<p>至此，<strong>Nginx-VTS → Exporter → Prometheus</strong> 整条链路就串好了：<br>
浏览器看 <code>/status</code> 能实时出图，Prometheus 也能收到完整指标，Grafana 再导入官方 Dashboard #2949 即可看到 QPS、5xx、延迟曲线。</p>
<hr>
<h1>2．ComfyUI 存活监控 &amp; 重启计数</h1>
<p>本节把「ComfyUI HTTP 探活 + 自动发现目标 + 告警」完整打通，而且<strong>不用传统 cron</strong>。黑盒探针仍采用官方 <code>prom/blackbox-exporter</code>，目标文件由一个极简 <strong>sidecar</strong> 守护脚本循环生成，全部交给 Docker-Compose 管理。</p>
<hr>
<h2 id="2-1-Blackbox-Exporter-服务">2.1 Blackbox Exporter 服务</h2>
<p><code>docker-compose.yml</code> 片段：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># Blackbox Exporter：探测 ComfyUI 是否在线（含 BASIC-AUTH、正则校验）</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="attr">blackbox-exporter:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">prom/blackbox-exporter:latest</span></span><br><span class="line">  <span class="attr">container_name:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./blackbox/blackbox.yml:/config/blackbox.yml:ro</span>      <span class="comment"># 模块定义</span></span><br><span class="line">  <span class="attr">secrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">comfy_pass</span>                                            <span class="comment"># BASIC-AUTH 密码</span></span><br><span class="line">  <span class="attr">command:</span> <span class="string">--config.file=/config/blackbox.yml</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9115:9115&quot;</span></span><br><span class="line">  <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure>
<h3 id="解释">解释</h3>
<ol>
<li><code>blackbox.yml</code> 里只保留自定义模块 <code>comfy_https</code>（见下一小节）。</li>
<li>密码通过 Docker Secret 注入：<code>/run/secrets/comfy_pass</code>。</li>
<li>监听 9115，Prometheus 抓这个端口即可。</li>
</ol>
<hr>
<h2 id="2-2-Blackbox-配置-blackbox-yml">2.2 Blackbox 配置 <code>blackbox.yml</code></h2>
<blockquote>
<p>文件路径：<code>./blackbox/blackbox.yml</code></p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">modules:</span></span><br><span class="line">  <span class="attr">comfy_https:</span></span><br><span class="line">    <span class="attr">prober:</span> <span class="string">http</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">15s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">method:</span> <span class="string">GET</span></span><br><span class="line">      <span class="attr">basic_auth:</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">password_file:</span> <span class="string">/run/secrets/comfy_pass</span>   <span class="comment"># ← 从 secret 读</span></span><br><span class="line">      <span class="attr">valid_status_codes:</span> [<span class="number">200</span>]                  <span class="comment"># 允许 200</span></span><br><span class="line">      <span class="attr">follow_redirects:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">tls_config:</span></span><br><span class="line">        <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span>               <span class="comment"># 跳过自签证书</span></span><br><span class="line">      <span class="attr">fail_if_body_not_matches_regexp:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;CheckpointLoaderSimple&quot;</span>               <span class="comment"># 返回体必须包含此关键字</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2-3-动态目标：File-SD，但不用-cron">2.3 动态目标：File-SD，但不用 cron</h2>
<p>思路：起一个极简 sidecar <strong>每 60 秒写一次</strong>目标文件；Prometheus 自带的 <code>file_sd_configs</code> 负责热加载，无需 cron/系统定时器。</p>
<h3 id="2-3-1-共享目标目录">2.3.1 共享目标目录</h3>
<p>先在 Compose 顶部声明一个卷，用于 <strong>Prometheus 与 sidecar 共享</strong>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">comfy_targets:</span></span><br></pre></td></tr></table></figure>
<h3 id="2-3-2-Prometheus-抓取配置">2.3.2 Prometheus 抓取配置</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">comfy_status</span></span><br><span class="line">    <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">    <span class="attr">params:</span></span><br><span class="line">      <span class="attr">module:</span> [<span class="string">comfy_https</span>]                 <span class="comment"># 指定上面定义的模块</span></span><br><span class="line">    <span class="attr">file_sd_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">files:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">/etc/prometheus/targets_comfy/*.json</span></span><br><span class="line">        <span class="attr">refresh_interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="comment"># 把文件里的 target 赋给 __param_target</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">      <span class="comment"># 展示用 instance/target 标签</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">target</span></span><br><span class="line">      <span class="comment"># 真正去抓 blackbox-exporter:9115</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">blackbox-exporter:9115</span></span><br></pre></td></tr></table></figure>
<p>挂卷别忘了：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">prometheus:</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">./prometheus.yml:/etc/prometheus/prometheus.yml:ro</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">comfy_targets:/etc/prometheus/targets_comfy</span>          <span class="comment"># 同一卷</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">prometheus_data:/prometheus</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="2-4-告警规则（Alertmanager）">2.4 告警规则（Alertmanager）</h2>
<p>TODO</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">groups:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">comfy</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">alert:</span> <span class="string">ComfyUI_Down</span></span><br><span class="line">      <span class="attr">expr:</span> <span class="string">probe_success&#123;job=&quot;comfy&quot;&#125;</span> <span class="string">==</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">for:</span> <span class="string">2m</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">severity:</span> <span class="string">critical</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">summary:</span> <span class="string">&quot;ComfyUI 实例不可用&quot;</span></span><br><span class="line">        <span class="attr">description:</span> <span class="string">&quot;实例 <span class="template-variable">&#123;&#123; $labels.instance &#125;&#125;</span> 已连续 2 分钟探测失败&quot;</span></span><br></pre></td></tr></table></figure>
<hr>
<p>至此，「ComfyUI 探活 + 自动目标发现 + 掘出来的指标和告警」全部打通，而且完全<strong>依赖 Docker-Compose 自带机制</strong>，不占用宿主的系统级 cron 服务。</p>
<hr>
<h1>3．GPU 指标采集（DCGM-Exporter 方案）</h1>
<p>目标：把显卡温度、功耗、显存占用、核心利用率等 DCGM 指标全部送进 Prometheus，随后在 Grafana 导入官方 Dashboard <code>DCGM Exporter / NVIDIA Data Center GPU Manager (ID: 12239)</code> 即可直接出图。</p>
<hr>
<h2 id="3-1-服务定义：gpu-exporter">3.1 服务定义：<code>gpu-exporter</code></h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="comment"># GPU Exporter —— NVIDIA 官方 DCGM Exporter</span></span><br><span class="line"><span class="comment">###############################################################################</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gpu-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nvidia/dcgm-exporter:4.2.3-4.1.3-ubuntu22.04</span>  <span class="comment"># 固定版本便于排障</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gpu-exporter</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 让容器拥有对宿主 GPU 的完全访问权</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span>                                      <span class="comment"># 等同于 --gpus all</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NVIDIA_VISIBLE_DEVICES=all</span>                       <span class="comment"># 全部 GPU</span></span><br><span class="line">      <span class="comment"># 如需屏蔽部分卡，可写: 0,2  或 GPU-UUID</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9400:9400&quot;</span>                                      <span class="comment"># Prometheus 抓取口</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br></pre></td></tr></table></figure>
<p>关键点说明</p>
<ol>
<li><code>runtime: nvidia</code> 要求宿主机已安装 <strong>nvidia-container-toolkit</strong>（<code>nvidia-docker2</code>）。</li>
<li>镜像标签采用「DCGM 版本-Driver 版本-基础 OS」，升级驱动后请一并升级镜像。</li>
</ol>
<hr>
<h2 id="3-2-Prometheus-抓取配置">3.2 Prometheus 抓取配置</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;gpu&quot;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">gpu-exporter:9400</span>       <span class="comment"># 与 compose 里的容器名 + 端口保持一致</span></span><br></pre></td></tr></table></figure>
<p>若想在查询 &amp; 告警里区分多机，可加一条固定标签：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;gpu&quot;</span></span><br><span class="line">  <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;gpu-exporter:9400&#x27;</span>]</span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">node:</span> <span class="string">gpu-node-01</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="3-3-常见指标速查">3.3 常见指标速查</h2>
<table>
<thead>
<tr>
<th>指标</th>
<th>含义</th>
<th>典型阈值</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>dcgm_gpu_utilization</code></td>
<td>核心利用率 (%)</td>
<td>&gt; 90% 持续 10 min 预警</td>
</tr>
<tr>
<td><code>dcgm_memory_used</code> / <code>dcgm_memory_total</code></td>
<td>显存占用 / 总量 (MiB)</td>
<td>剩余 &lt; 500 MiB 警报</td>
</tr>
<tr>
<td><code>dcgm_power_usage</code></td>
<td>实时功耗 (W)</td>
<td>逼近 <code>dcgm_power_limit</code></td>
</tr>
<tr>
<td><code>dcgm_temperature</code></td>
<td>GPU 核温 (℃)</td>
<td>&gt; 80 ℃ 告警</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="3-4-Grafana-快速出图">3.4 Grafana 快速出图</h2>
<ol>
<li>在 Grafana → Dashboards → Import</li>
<li>输入 <code>12239</code>（官方 DCGM Dashboard ID）</li>
<li>选择数据源 <code>Prometheus</code> → Import 完成</li>
</ol>
<p>即可得到温度 / 利用率 / 显存 / 功耗多维度概览。</p>
<hr>
<p>至此，GPU 监控链路 <code>DCGM Exporter → Prometheus → Grafana</code> 配置完毕，若后续新增 GPU 主机，只需把同样的 <code>gpu-exporter</code> 服务抄过去再加个 scrape target 即可复用。</p>
<hr>
<h1>4. Docker &amp; VPN 网段冲突处理</h1>
<h2 id="4-1-一劳永逸：限制-Docker-地址池">4.1 一劳永逸：限制 Docker 地址池</h2>
<p><code>/etc/docker/daemon.json</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;default-address-pools&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span> <span class="attr">&quot;base&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.240.0/20&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;size&quot;</span><span class="punctuation">:</span> <span class="number">24</span> <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p><code>systemctl restart docker</code></p>
<h2 id="4-2-快速兜底：统一外部网络-dnet1">4.2 快速兜底：统一外部网络 dnet1</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker network create \</span><br><span class="line">  --subnet 192.168.250.0/24 \</span><br><span class="line">  --gateway 192.168.250.1 \</span><br><span class="line">  dnet1</span><br></pre></td></tr></table></figure>
<p>所有 Compose 结尾追加：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dnet1</span></span><br></pre></td></tr></table></figure>
<hr>
<h1>5. 最终 docker-compose.monitor.yml（完整版）</h1>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/prometheus:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./prometheus/comfy_service_url.json:/etc/prometheus/targets_comfy.json:ro</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">prometheus_data:/prometheus</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9090:9090&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">extra_hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;host.docker.internal:host-gateway&quot;</span></span><br><span class="line">  <span class="attr">gpu-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nvidia/dcgm-exporter:4.2.3-4.1.3-ubuntu22.04</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">gpu-exporter</span></span><br><span class="line">    <span class="attr">runtime:</span> <span class="string">nvidia</span> <span class="comment"># 参考 https://developer.nvidia.com/container-runtime</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NVIDIA_VISIBLE_DEVICES=all</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9400:9400&quot;</span></span><br><span class="line">  <span class="attr">node-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/node-exporter:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">network_mode:</span> <span class="string">host</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">  <span class="attr">blackbox-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">prom/blackbox-exporter:latest</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">blackbox-exporter</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./blackbox/blackbox.yml:/config/blackbox.yml:ro</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">--config.file=/config/blackbox.yml</span></span><br><span class="line">    <span class="attr">secrets:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">comfy_pass</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9115:9115&quot;</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./nginx-vts</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-vts</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/base.crt:/etc/nginx/ssl/base.crt</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/base.key:/etc/nginx/ssl/base.key</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/nginx.conf:/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/proxy_common.conf:/etc/nginx/conf.d/proxy_common.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./nginx-vts/.htpasswd:/etc/nginx/.htpasswd</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;443:443&quot;</span></span><br><span class="line">  <span class="attr">nginx-vts-exporter:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">sophos/nginx-vts-exporter</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-vts-exporter</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">NGINX_STATUS=https://admin:wv7edp3cx4@nginx:443/status/format/json</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">TLS_SKIP_VERIFY=true</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;9913:9913&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">comfyd-linux:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">./self-service</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">comfyd-driver</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/recast-multi-1/docker-compose.yml:/data/recast-multi-1/docker-compose.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/flux-20002/docker-compose.yml:/data/flux-20002/docker-compose.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/flux-20003/docker-compose.yml:/data/flux-20003/docker-compose.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/hidream-20000/docker-compose.yml:/data/hidream-20000/docker-compose.yml</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/hidream-20001/docker-compose.yml:/data/hidream-20001/docker-compose.yml</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">unless-stopped</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;4001:4001&quot;</span></span><br><span class="line"><span class="attr">secrets:</span></span><br><span class="line">  <span class="attr">comfy_pass:</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">./blackbox/comfy_pass</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">prometheus_data:</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">default:</span></span><br><span class="line">    <span class="attr">external:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">dnet1</span></span><br></pre></td></tr></table></figure>
<hr>
<h1>6. 小结</h1>
<ol>
<li><strong>Nginx</strong> 用 VTS 模块 / exporter 拿到完整维度</li>
<li><strong>ComfyUI</strong> 用 Blackbox + file SD，2 分钟探活告警</li>
<li><strong>GPU</strong> 官方 dcgm-exporter，Grafana 官方 dashboard #12239 即可</li>
<li><strong>Docker+VPN</strong> 要么改 AddressPool，要么所有 Compose 进同一个 bridge</li>
<li><strong>Prometheus</strong> 模板化 relabel，YAML 少写一半</li>
</ol>
<blockquote>
<p>至此，从系统资源 → GPU → 入口 Nginx → 应用存活，全链路监控闭环完成。<br>
Happy Hacking 🎉</p>
</blockquote>
</div><div class="article-licensing box"><div class="licensing-title"><p>Prometheus 全链路监控实战： Nginx QPS、ComfyUI 存活、GPU 指标，到 Docker-VPN 网段踩坑记录</p><p><a href="https://zion4h.github.io/2025/06/09/2025-6-9-Prometheus进阶-Nginx负载、Comfy存活、GPU节点与YAML精简/">https://zion4h.github.io/2025/06/09/2025-6-9-Prometheus进阶-Nginx负载、Comfy存活、GPU节点与YAML精简/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>zion h4</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2025-06-09</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2025-06-16</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Prometheus/">Prometheus</a><a class="link-muted mr-2" rel="tag" href="/tags/Nginx/">Nginx</a><a class="link-muted mr-2" rel="tag" href="/tags/GPU/">GPU</a><a class="link-muted mr-2" rel="tag" href="/tags/Blackbox/">Blackbox</a><a class="link-muted mr-2" rel="tag" href="/tags/Docker/">Docker</a></div><div class="sharethis-inline-share-buttons"></div><script src="https://platform-api.sharethis.com/js/sharethis.js#property=641e7fdbd0e85900127dc9ed&amp;product=inline-share-buttons&amp;source=platform" defer></script></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2025/04/30/2025-4-30-Nginx%E7%AE%A1%E7%90%86-%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE/"><span class="level-item">Nginx 管理&amp;端口转发权限配置</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="comment-container"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@1.7.2/dist/gitalk.min.js"></script><script>var gitalk = new Gitalk({
            id: "3c8aab7d659af26d1704e417d827d4a4",
            repo: "zion4h.github.io",
            owner: "zion4h",
            clientID: "6f5a7e1a8b910087187d",
            clientSecret: "24cd36d0774c992dbd5536246799438ee849c1da",
            admin: ["zion4h"],
            createIssueManually: false,
            distractionFreeMode: false,
            perPage: 10,
            pagerDirection: "last",
            
            
            enableHotKey: true,
            
        })
        gitalk.render('comment-container')</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1 is-sticky"><div class="card widget" id="toc" data-type="toc"><div class="card-content"><div class="menu"><h3 class="menu-label">目录</h3><ul class="menu-list"><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">1</span><span class="level-item">0. 环境 &amp; 踩坑摘要</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">2</span><span class="level-item">1．Nginx 负载监控</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-直接使用自编译-VTS-模块的-Nginx"><span class="level-left"><span class="level-item">2.1</span><span class="level-item">1.1 直接使用自编译 VTS 模块的 Nginx</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#1-1-1-docker-compose-yml-片段"><span class="level-left"><span class="level-item">2.1.1</span><span class="level-item">1.1.1 docker-compose.yml 片段</span></span></a></li><li><a class="level is-mobile" href="#1-1-2-Dockerfile（双阶段编译）"><span class="level-left"><span class="level-item">2.1.2</span><span class="level-item">1.1.2 Dockerfile（双阶段编译）</span></span></a></li><li><a class="level is-mobile" href="#1-1-3-nginx-conf（精简只展示-VTS-相关）"><span class="level-left"><span class="level-item">2.1.3</span><span class="level-item">1.1.3 nginx.conf（精简只展示 VTS 相关）</span></span></a></li><li><a class="level is-mobile" href="#1-1-4-Prometheus-抓取示例（仅供参考）"><span class="level-left"><span class="level-item">2.1.4</span><span class="level-item">1.1.4 Prometheus 抓取示例（仅供参考）</span></span></a></li></ul></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">3</span><span class="level-item">2．ComfyUI 存活监控 &amp; 重启计数</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-1-Blackbox-Exporter-服务"><span class="level-left"><span class="level-item">3.1</span><span class="level-item">2.1 Blackbox Exporter 服务</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#解释"><span class="level-left"><span class="level-item">3.1.1</span><span class="level-item">解释</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-2-Blackbox-配置-blackbox-yml"><span class="level-left"><span class="level-item">3.2</span><span class="level-item">2.2 Blackbox 配置 blackbox.yml</span></span></a></li><li><a class="level is-mobile" href="#2-3-动态目标：File-SD，但不用-cron"><span class="level-left"><span class="level-item">3.3</span><span class="level-item">2.3 动态目标：File-SD，但不用 cron</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#2-3-1-共享目标目录"><span class="level-left"><span class="level-item">3.3.1</span><span class="level-item">2.3.1 共享目标目录</span></span></a></li><li><a class="level is-mobile" href="#2-3-2-Prometheus-抓取配置"><span class="level-left"><span class="level-item">3.3.2</span><span class="level-item">2.3.2 Prometheus 抓取配置</span></span></a></li></ul></li><li><a class="level is-mobile" href="#2-4-告警规则（Alertmanager）"><span class="level-left"><span class="level-item">3.4</span><span class="level-item">2.4 告警规则（Alertmanager）</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">4</span><span class="level-item">3．GPU 指标采集（DCGM-Exporter 方案）</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#3-1-服务定义：gpu-exporter"><span class="level-left"><span class="level-item">4.1</span><span class="level-item">3.1 服务定义：gpu-exporter</span></span></a></li><li><a class="level is-mobile" href="#3-2-Prometheus-抓取配置"><span class="level-left"><span class="level-item">4.2</span><span class="level-item">3.2 Prometheus 抓取配置</span></span></a></li><li><a class="level is-mobile" href="#3-3-常见指标速查"><span class="level-left"><span class="level-item">4.3</span><span class="level-item">3.3 常见指标速查</span></span></a></li><li><a class="level is-mobile" href="#3-4-Grafana-快速出图"><span class="level-left"><span class="level-item">4.4</span><span class="level-item">3.4 Grafana 快速出图</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">5</span><span class="level-item">4. Docker &amp; VPN 网段冲突处理</span></span></a><ul class="menu-list"><li><a class="level is-mobile" href="#4-1-一劳永逸：限制-Docker-地址池"><span class="level-left"><span class="level-item">5.1</span><span class="level-item">4.1 一劳永逸：限制 Docker 地址池</span></span></a></li><li><a class="level is-mobile" href="#4-2-快速兜底：统一外部网络-dnet1"><span class="level-left"><span class="level-item">5.2</span><span class="level-item">4.2 快速兜底：统一外部网络 dnet1</span></span></a></li></ul></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">6</span><span class="level-item">5. 最终 docker-compose.monitor.yml（完整版）</span></span></a></li><li><a class="level is-mobile" href="#"><span class="level-left"><span class="level-item">7</span><span class="level-item">6. 小结</span></span></a></li></ul></div></div><style>#toc .menu-list > li > a.is-active + .menu-list { display: block; }#toc .menu-list > li > a + .menu-list { display: none; }</style><script src="/js/toc.js" defer></script></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="/img/kitty.png" alt="Blowin&#039; in the Wind" height="28"></a><p class="is-size-7"><span>&copy; 2025 zion h4</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a><br><span id="busuanzi_container_site_uv">共<span id="busuanzi_value_site_uv">0</span>个访客</span></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0" href="https://creativecommons.org/licenses/by-nc-sa/4.0/"><i></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/zion4h"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.9/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>